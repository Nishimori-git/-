import sys
import pygame
from pygame.locals import*
pygame.init()
import sys
import random

STATE_TITLE = 0
STATE_SETUMEI = 1
STATE_GAME = 2
STATE_GAMEOVER = 3

font = pygame.font.Font(None, 36)

def main():
    pygame.init()
    pygame.mixer.init()
    screen = pygame.display.set_mode((1000, 300))
    background = pygame.image.load("haikei_1000_300.png").convert()
    pygame.display.set_caption("逃げるはアリだが役に立つ")

    clock = pygame.time.Clock()

    state = STATE_TITLE
    while True:
        if state == STATE_TITLE:
            pygame.mixer.music.load("Titlemusic.mp3")
            pygame.mixer.music.play(-1)
            state = title_loop(screen)

        elif state == STATE_SETUMEI:
            state = setumei_loop(screen)

        elif state == STATE_GAME:
            pygame.mixer.music.load("Gamemusic.mp3")
            pygame.mixer.music.play(-1)

            state = game_loop(screen)

        elif state == STATE_GAMEOVER:
            pygame.mixer.music.load("Gameovermusic.mp3")
            pygame.mixer.music.play(-1)
            state = gameover_loop(screen)

        clock.tick(60)

def game_loop(screen):
    clock = pygame.time.Clock()

    background = pygame.image.load("haikei_1000_300.png").convert()

    #画像の配置を決定（ランダム生成の時は多分ここの数値をいじる）
    x1 = random.randint(200, 400)
    x2 = random.randint(800, 900)
    x3 = random.randint(200, 1000)
    player = Player("Player.png")
    rock = Rock("Rock.png", x1, 240)
    water = Water("Water.png", x2, 240)
    candy = Candy("Candy.png", x3, 180)
    mountain = Mountain("Mountain.png",300, 330)
    hill = Hill("Hill.png",800, 345)
    foot = Foot("foot.png",0, 300)
    plate = Plate("Plate.png",1000, 320)
    scroll_speed = 5

    start_time = pygame.time.get_ticks()
    STATE_GAMEOVER = False

    while True:
      for event in pygame.event.get(): #ジャンプ処理
          if event.type == QUIT:
              pygame.quit()
              sys.exit()
          if event.type == KEYDOWN and event.key == K_SPACE:
              player.jump()
              player.jsound.play()

      #衝突判定
      if pygame.sprite.collide_rect(player, rock) and not player.hit:
          player.rect.x -= 30
          player.hit = True
          player.hittime = 50
          player.image = player.image_r
          player.rsound.play()

      elif pygame.sprite.collide_rect(player, water) and not player.hit:
          player.rect.x -= 20
          player.hit = True
          player.hittime = 40
          player.image = player.image_w
          player.wsound.play()

      elif pygame.sprite.collide_rect(player, candy):
          player.rect.x += 20
          player.hit = True
          player.hittime = 10
          candy.rect.x = -100
          
      elif pygame.sprite.collide_rect(player, plate):
          if (player.vel_y >= 0 and
              player.prev.bottom <= plate.rect.top):
              player.rect.bottom = plate.rect.top
              player.vel_y = 0
              player.jump_now = False

      if player.rect.x <= 50 and not player.hit:
          player.hit = True
          player.gsound.play()
          player.image = player.image_go
          pygame.time.delay(2000)
          return STATE_GAMEOVER
          player.rect.x = 400

      #時間表示
      elapsed_time = (pygame.time.get_ticks() - start_time) // 1000
      time_text = font.render(f"Time: {elapsed_time}", True, (0, 0, 0))
      screen.blit(time_text, (850, 10))
      pygame.display.flip()


      player.update()
      rock.update(scroll_speed)
      water.update(scroll_speed)
      candy.update(scroll_speed)
      mountain.update(scroll_speed)
      hill.update(scroll_speed)
      plate.update(scroll_speed)

      #画像配置
      screen.blit(background,(0,0))
      screen.blit(mountain.image, mountain.rect)
      screen.blit(hill.image, hill.rect)
      screen.blit(plate.image,plate.rect)
      screen.blit(foot.image, foot.rect)
      screen.blit(player.image, player.rect)
      screen.blit(rock.image, rock.rect)
      screen.blit(water.image, water.rect)
      screen.blit(candy.image, candy.rect)

      #pygame.display.update()
      clock.tick(60)
        

def gameover_loop(screen):
    clock = pygame.time.Clock()
    image = pygame.image.load("gameover.png").convert()

    while True:
        for event in pygame.event.get():
            if event.type == QUIT:
                pygame.quit()
                sys.exit()
            if event.type == KEYDOWN and event.key == K_SPACE:
                pygame.mixer.music.stop()
                return STATE_GAME

        screen.blit(image, (0, 0))
        pygame.display.update()
        clock.tick(60)

def title_loop(screen):
    clock = pygame.time.Clock()
    image = pygame.image.load("title.png").convert()

    pygame.mixer.music.load("Titlemusic.mp3")
    pygame.mixer.music.play(-1)

    while True:
        for event in pygame.event.get():
            if event.type == QUIT:
                pygame.quit()
                sys.exit()
            if event.type == KEYDOWN and event.key == K_SPACE:
                return STATE_SETUMEI

        screen.blit(image, (0, 0))
        pygame.display.update()
        clock.tick(60)

def setumei_loop(screen):
    clock = pygame.time.Clock()
    image = pygame.image.load("setumei.png").convert()

    while True:
        for event in pygame.event.get():
            if event.type == QUIT:
                pygame.quit()
                sys.exit()
            if event.type == KEYDOWN and event.key == K_SPACE:
                pygame.mixer.music.stop()
                return STATE_GAME

        screen.blit(image, (0, 0))
        pygame.display.update()
        clock.tick(60)

class Player(pygame.sprite.Sprite):
    gravity = 0.7
    jump_power = -16

    def __init__(self, image_path):
        super().__init__()

        #画像・効果音読み込み
        self.image_n = pygame.image.load(image_path).convert_alpha()
        self.image_n = pygame.transform.scale(self.image_n, (100, 100))

        self.image_r = pygame.image.load("Player_Rockver.png").convert_alpha()
        self.image_r = pygame.transform.scale(self.image_r, (80, 80))

        self.image_w = pygame.image.load("Player_Waterver.png").convert_alpha()
        self.image_w = pygame.transform.scale(self.image_w, (100, 100))

        self.image_go = pygame.image.load("Player_gameover.png").convert_alpha()
        self.image_go = pygame.transform.scale(self.image_go, (100, 100))

        self.rsound = pygame.mixer.Sound("Player_Rocksound.mp3")
        self.wsound = pygame.mixer.Sound("Player_Watersound.mp3")
        self.jsound = pygame.mixer.Sound("Jumpsound.mp3")
        self.gsound = pygame.mixer.Sound("Player_gameoversound.mp3")

        self.image = self.image_n
        self.rect = self.image.get_rect()
        self.rect = self.rect.inflate(-20,-20)
        self.rect.x = 400
        self.rect.bottom = 200

        self.hit = False
        self.hittime = 0
        self.vel_y = 0
        self.jump_now = False

    def update(self):
        self.prev = self.rect.copy()
        # 重力
        self.vel_y += self.gravity
        self.rect.y += self.vel_y
        
        # 地面
        if self.rect.bottom >= 300:
            self.rect.bottom = 300
            self.vel_y = 0
            self.jump_now = False
        # ノックバック
        if self.hit:
            self.hittime -= 1
            if self.hittime <= 0:
                self.hit = False
                self.image = self.image_n

    def jump(self):
        if not self.jump_now:
            self.vel_y = self.jump_power
            self.jump_now = True


            

class Rock(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
        super().__init__()
        self.image = pygame.image.load(image_path).convert_alpha()
        self.image = pygame.transform.scale(self.image, (80, 70))

        self.rect = self.image.get_rect()
        self.rect.topleft = (x,y)
        
        s1 = random.randint(2, 4)
        self.speed = s1
        self.slow = 2

    def update(self,scroll_speed):
        self.rect.x -= self.speed
        sr1 = random.randint(700, 1000)
        if self.rect.x <= 0:
           self.rect.x = sr1

class Water(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
        super().__init__()
        self.image = pygame.image.load(image_path).convert_alpha()
        self.image = pygame.transform.scale(self.image, (180, 90))
        self.rect = self.image.get_rect()
        self.rect.topleft = (x,y)
        s2 = random.randint(0, 2)
        self.slow = s2

    def update(self,scroll_speed):
        self.rect.x -= scroll_speed
        sr2 = random.randint(700, 1000)
        if self.rect.x <= 0:
           self.rect.x = sr2

class Candy(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
         super().__init__()
         self.image = pygame.image.load(image_path).convert_alpha()
         self.image = pygame.transform.scale(self.image, (50,50))
         self.rect = self.image.get_rect()
         self.rect.topleft = (x,y)
         s3 = random.randint(3, 6)
         self.speed = s3
    def update(self,scroll_speed):
        self.rect.x -= self.speed
        sr3 = random.randint(700, 1000)
        if self.rect.x <= -700:
           self.rect.x = sr3

class Mountain(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
         super().__init__()
         self.image = pygame.image.load(image_path).convert_alpha()
         self.image = pygame.transform.scale(self.image, (400,300))
         self.rect = self.image.get_rect()
         self.rect.bottomleft = (x,y)
         self.speed = 1.5

    def update(self,scroll_speed):
         self.rect.x -= self.speed
         
         if self.rect.x <= -400:
           self.rect.x = 1000

class Hill(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
         super().__init__()
         self.image = pygame.image.load(image_path).convert_alpha()
         self.image = pygame.transform.scale(self.image, (400,270))
         self.rect = self.image.get_rect()
         self.rect.bottomleft = (x,y)
         self.speed = 3

    def update(self,scroll_speed):
         self.rect.x -= self.speed
         if self.rect.x <= -400:
           self.rect.x = 1000

class Foot(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
         super().__init__()
         self.image = pygame.image.load(image_path).convert_alpha()
         self.image = pygame.transform.scale(self.image, (150,300))
         self.rect = self.image.get_rect()
         self.rect.bottomleft = (x,y)

class Plate(pygame.sprite.Sprite):
    def __init__(self, image_path,x,y):
         super().__init__()
         self.image = pygame.image.load(image_path).convert_alpha()
         self.image = pygame.transform.scale(self.image, (400,100))
         self.rect = self.image.get_rect()
         self.rect.bottomleft = (x,y)

    def update(self,scroll_speed):
         self.rect.x -= scroll_speed
         if self.rect.x <= -400:
           self.rect.x = 1000

if __name__ == "__main__":
    main()
